<!DOCTYPE html>
<html>

<head>
    <title>Test (New Storage)</title>
</head>

<body>
    <div id='output'></div>
    <div style="margin-top: 50px;"></div>
    <button id="btnFade">Stop Fading</button>
    <div id="result" style="margin-top: 10px;">fade me</div>
    <div style="margin-top: 40px;"></div>
    <button id="access" style="display: none;">Get Access</button>
    <div style="margin-top:25px"></div>
    <button id="saveid" disabled="true">SaveId</button>
</body>

</html>

<style>
    .hide {
        opacity: 0;
        transition: opacity 2000ms;
    }

    .show {
        opacity: 1;
        transition: opacity 2000ms;
    }
</style>

<script>
    (function () {
        // your page initialization code here
        // the DOM will be available here
        // Opera 8.0+
        var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;

        // Firefox 1.0+
        var isFirefox = typeof InstallTrigger !== 'undefined';

        // Safari 3.0+ "[object HTMLElementConstructor]" 
        var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));

        // Edge 20+
        var isEdge = !!window.StyleMedia;

        // Chrome 1 - 79
        var isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime) && !(navigator.userAgent.indexOf("Edg") != -1);

        // Edge (based on chromium) detection
        var isEdgeChromium = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime) && (navigator.userAgent.indexOf("Edg") != -1);
        // Blink engine detection

        var isBlink = (isChrome || isOpera) && !!window.CSS;
        var output = 'Detecting browsers by ducktyping:<hr>';
        output += 'isFirefox: ' + isFirefox + '<br>';
        output += 'isChrome: ' + isChrome + '<br>';
        output += 'isSafari: ' + isSafari + '<br>';
        output += 'isOpera: ' + isOpera + '<br>';
        output += 'isEdge: ' + isEdge + '<br>';
        output += 'isEdgeChromium: ' + isEdgeChromium + '<br>';
        output += 'isBlink: ' + isBlink + '<br>';
        document.getElementById('output').innerHTML = output;

        //FADE
        var runningFade = true;

        function fadeIn(el) {
            el.classList.add('show');
            el.classList.remove('hide');
        }

        function fadeOut(el) {
            el.classList.add('hide');
            el.classList.remove('show');
        }

        var btn = document.getElementById('btnFade');
        var img = document.getElementById('result');

        btn.addEventListener('click', function () {
            runningFade = !runningFade;
        });


        function start() {
            setTimeout(fadeToggle, 0)
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fadeToggle() {
            while (runningFade) {
                if (img.className.indexOf('hide') !== -1) {
                    fadeIn(img);
                    this.innerHTML = 'Fade Out';
                }
                else {
                    fadeOut(img);
                    this.innerHTML = 'Fade In';
                }
                await sleep(2000);
            }
        }
        start();

        //TEST
        console.log('test');

        var sourceInKey = 'sourcein-id';

        function getId() {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(sourceInKey);
                if (c_start != -1) {
                    c_start = c_start + sourceInKey.length + 1;
                    c_end = document.cookie.indexOf(';', c_start);
                    if (c_end == -1) {
                        c_end = document.cookie.length;
                    }
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            var id = uuidv4();
            document.cookie = sourceInKey + "=" + id + '; SameSite=None; Secure; Expires=Tue, 19 Jan 2038 03:14:07 UTC';
            return id;
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) { var r = 16 * Math.random() | 0; return ('x' == c ? r : r & 3 | 8).toString(16) });
        }

        function accesReady() {
            document.getElementById('saveid').disabled = false;
        }


        document.getElementById('access').onclick = function () {
            var promise = document.requestStorageAccess();
            promise.then(
                function () {
                    console.log('access was granted');
                    accesReady();
                },
                function () {
                    console.log('access was denied');
                }
            );
        };


        if (isChrome) {
            accesReady()
        }
        else {
            var promise = document.hasStorageAccess();
            promise.then(
                function (hasAccess) {
                    console.log('has access');
                    console.log(hasAccess);

                    accesReady();
                },
                function (reason) {
                    console.log('no access');
                    console.log(reason);
                    document.getElementById('access').style.display = 'inherit';
                }
            );
        }

        //save id 
        document.getElementById('saveid').onclick = function () {
            alert(getId());
        }
    })();
</script>